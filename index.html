<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMAR - Avaliação de Risco com Análise de Dados</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js for summary chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- SheetJS (XLSX) for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK (Compatibility version for local file execution) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>


    <style>
        /* Custom styles to enhance the UI */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease-in-out;
            overflow: hidden; /* Needed for the new header style */
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .header-title {
            color: #111827;
        }
        .btn {
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: white; }
        .btn-success:hover { background-color: #16a34a; }
        
        .risk-score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            font-weight: 700;
            font-size: 1.25rem;
        }

        /* Matrix Styles */
        .risk-matrix-container {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem;
            align-items: center;
        }
        .risk-matrix {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            padding: 2px;
            width: 150px; /* Fixed width for the matrix */
        }
        .matrix-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            border-radius: 0.125rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .matrix-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        .matrix-cell.selected {
            border: 2px solid #ffffff;
            box-shadow: 0 0 0 2px #3b82f6;
            transform: scale(1.1);
            z-index: 5;
        }
        .axis-label {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
        }
        .consequence-labels {
            grid-column: 2;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
        }

        /* Cell Colors */
        .risk-low { background-color: #22c55e; }
        .risk-moderate { background-color: #facc15; }
        .risk-high { background-color: #f97316; }
        .risk-extreme { background-color: #ef4444; }

        /* Extreme Risk Alert Styles */
        .extreme-risk-alert-row {
            border: 2px solid #ef4444 !important;
            background-color: #fef2f2;
        }
        .extreme-risk-icon {
            color: #ef4444;
            display: none; /* Hidden by default */
        }
        .extreme-risk-alert-row .extreme-risk-icon {
            display: inline-block; /* Show when row has alert class */
        }
        
        /* Page Navigation */
        .nav-button {
            border-bottom: 4px solid transparent;
        }
        .nav-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <!-- SVG Icon for Alert -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-alert-triangle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </symbol>
    </svg>

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold header-title">CMAR</h1>
            <p class="text-lg text-gray-600 mt-2">Checklist e Matriz de Avaliação do Risco em Desportos de Montanha</p>
        </header>

        <!-- Navigation -->
        <nav class="bg-white rounded-lg shadow p-2 mb-8 flex justify-center gap-4">
            <button id="nav-assessment" class="nav-button active text-lg font-semibold py-2 px-4">Nova Avaliação</button>
            <button id="nav-dashboard" class="nav-button text-lg font-semibold py-2 px-4">Dashboard de Análise</button>
        </nav>

        <!-- Page: New Assessment -->
        <div id="page-assessment" class="page active">
            <!-- General Information Card -->
            <div id="general-info-card" class="card p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 border-b pb-2">Informações da Avaliação</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="evaluatorName" class="block text-sm font-medium text-gray-700">Nome do Avaliador</label>
                        <input type="text" id="evaluatorName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Insira o seu nome">
                    </div>
                    <div>
                        <label for="evalDate" class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="date" id="evalDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700">Local da Atividade</label>
                        <input type="text" id="location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ex: Serra da Estrela">
                    </div>
                    <div>
                        <label for="activity" class="block text-sm font-medium text-gray-700">Atividade</label>
                        <input type="text" id="activity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ex: Canyoning">
                    </div>
                </div>
            </div>

            <!-- Risk Assessment Section -->
            <div id="risk-factors-container">
                <!-- Risk factor dimensions will be injected here by JavaScript -->
            </div>

            <!-- Results and Actions Card for Assessment Page -->
            <div id="results-card-assessment" class="card p-6 mt-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 border-b pb-2">Resultados e Ações</h2>
                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="calculate-btn-assessment" class="btn btn-primary font-bold py-2 px-4 rounded-lg shadow-md">
                        Calcular Resultados
                    </button>
                    <button id="save-assessment-btn" class="btn btn-secondary font-bold py-2 px-4 rounded-lg shadow-md">
                        Guardar Avaliação
                    </button>
                    <button id="export-pdf-btn" class="btn btn-secondary font-bold py-2 px-4 rounded-lg shadow-md">
                        Exportar PDF
                    </button>
                     <button id="export-excel-btn" class="btn btn-success font-bold py-2 px-4 rounded-lg shadow-md">
                        Exportar Excel
                    </button>
                     <button id="clear-btn" class="btn btn-danger font-bold py-2 px-4 rounded-lg shadow-md">
                        Limpar Formulário
                    </button>
                </div>
                 <p id="save-status" class="mt-4 text-green-600 font-semibold"></p>

                <div id="results-content-assessment" class="hidden">
                    <!-- Extreme Risk Alerts Summary -->
                    <div id="extreme-risk-summary-container" class="hidden mb-8">
                        <h3 class="text-xl font-bold text-red-600 flex items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use xlink:href="#icon-alert-triangle"></use></svg>
                            Alertas de Risco Extremo
                        </h3>
                        <div id="extreme-risk-list" class="mt-2 p-4 bg-red-50 border border-red-200 rounded-lg text-red-800">
                            <!-- List of extreme risks will be populated here -->
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Overall Score and Classification -->
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Avaliação Geral</h3>
                            <div id="overall-result" class="p-4 rounded-lg text-center flex flex-col justify-center h-full">
                                <p id="overall-classification" class="text-4xl font-bold"></p>
                                <div class="mt-4 text-left p-4 bg-gray-100 rounded-lg">
                                    <p class="font-bold">Recomendação: <span id="overall-recommendation" class="font-normal"></span></p>
                                    <p class="font-bold mt-2">Tratamento/Ação: <span id="overall-treatment" class="font-normal"></span></p>
                                </div>
                            </div>
                        </div>
                        <!-- Summary Chart -->
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Resumo por Dimensão (Nº de Fatores)</h3>
                            <div class="h-64">
                                <canvas id="assessment-summary-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page: Dashboard -->
        <div id="page-dashboard" class="page">
            <div class="card p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 border-b pb-2">Filtros de Análise</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <input type="date" id="filter-start-date" class="rounded-md border-gray-300 shadow-sm">
                    <input type="date" id="filter-end-date" class="rounded-md border-gray-300 shadow-sm">
                    <input type="text" id="filter-location" placeholder="Filtrar por local..." class="rounded-md border-gray-300 shadow-sm">
                    <input type="text" id="filter-evaluator" placeholder="Filtrar por avaliador..." class="rounded-md border-gray-300 shadow-sm">
                </div>
                 <button id="apply-filters-btn" class="mt-4 btn btn-primary py-2 px-4 rounded-lg">Aplicar Filtros</button>
                 <button id="export-filtered-excel-btn" class="mt-4 btn btn-success py-2 px-4 rounded-lg">Exportar Filtrados (Excel)</button>
            </div>

            <div class="card p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 border-b pb-2">Análise Gráfica Agregada</h2>
                <div class="h-80">
                    <canvas id="analysis-chart"></canvas>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 border-b pb-2">Histórico de Avaliações</h2>
                <div id="assessment-history-list" class="space-y-4">
                    <p>A carregar avaliações...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- SCRIPT START ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- FIREBASE CONFIG (Compatibility version) ---
            // THIS BLOCK IS REPLACED WITH YOUR ACTUAL FIREBASE CONFIG
            const firebaseConfig = {
              apiKey: "AIzaSyA_ZmP3k0wob6jqoEV-k0KP1NjD2zKN5Ds",
              authDomain: "cmar-4866b.firebaseapp.com",
              projectId: "cmar-4866b",
              storageBucket: "cmar-4866b.firebasestorage.app",
              messagingSenderId: "481963120706",
              appId: "1:481963120706:web:42a8712b0fa153b12d75db"
            };

            let isFirebaseInitialized = false;
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                isFirebaseInitialized = true;
            } catch (e) {
                console.error("Firebase initialization failed. App will run in offline mode.", e);
            }

            const auth = isFirebaseInitialized ? firebase.auth() : null;
            const db = isFirebaseInitialized ? firebase.firestore() : null;
            
            let authReady = false;
            let allAssessments = [];
            let filteredAssessments = [];
            let analysisChart = null;
            let assessmentSummaryChart = null;

            // --- AUTHENTICATION ---
            if (auth) {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        authReady = true;
                        loadAssessments(); // Load data once authenticated
                    } else {
                         try {
                            // No need for initial auth token, just sign in anonymously
                            await auth.signInAnonymously();
                        } catch (error) {
                            console.error("Anonymous Authentication Error:", error);
                        }
                    }
                });
            }


            // --- DATA ---
            const riskData = {
                "Humana": [ { id: "H1", text: "Nível de experiência na modalidade (Técnico)" }, { id: "H2", text: "Competências de resgate e socorrismo (Técnico)" }, { id: "H3", text: "Informações dos procedimentos de segurança aos praticantes (Técnico)" }, { id: "H4", text: "Rácio técnico/praticantes" }, { id: "H5", text: "Utilização de procedimentos de segurança (Técnico)" }, { id: "H6", text: "Capacidade de liderança e tomada de decisão (Técnico)" }, { id: "H7", text: "Competências de planeamento e gestão (Técnico)" }, { id: "H8", text: "Conhecimento dos locais de prática e dos seus perigos (Técnico)" }, { id: "H9", text: "Competências de intervenção pedagógica e profissional (Técnico)" }, { id: "H10", text: "Condição física (Técnico)" }, { id: "H11", text: "Vestuário e calçado adequado (Praticante)" }, { id: "H12", text: "Nível de experiência na modalidade (Praticante)" }, { id: "H13", text: "Conduta de procedimentos de segurança (Praticante)" }, ],
                "Ambiental": [ { id: "A1", text: "Temperatura" }, { id: "A2", text: "Condições adversas extremas (vento, trovoada, neve, chuva e nevoeiro)" }, { id: "A3", text: "Estado de conservação do meio ambiente" }, { id: "A4", text: "Acesso a veículos de socorro ou outros" }, { id: "A5", text: "Comunicações (rede telemóvel, rádios transmissores)" }, { id: "A6", text: "Dificuldade do percurso" }, { id: "A7", text: "Duração do percurso" }, { id: "A8", text: "Nível da água (Apenas canyoning)" }, { id: "A9", text: "Tipo e qualidade da rocha (Apenas canyoning e escalada)" }, { id: "A10", text: "Exposição solar (Apenas escalada)" }, ],
                "Materiais e Equipamentos": [ { id: "M1", text: "Utilização de materiais e equipamentos certificados (homologados)" }, { id: "M2", text: "Manutenção e preservação dos materiais e equipamentos" }, { id: "M3", text: "Características dos materiais e equipamentos" }, { id: "M4", text: "Manipulação dos materiais e equipamentos" }, { id: "M5", text: "Adequação dos materiais e equipamentos ao nível dos praticantes" }, { id: "M6", text: "Estado de conservação dos equipamentos fixos existentes nas vias (Apenas escalada)" }, { id: "M7", text: "Performance dos materiais e equipamentos" }, ],
                "Segurança e Emergência": [ { id: "S1", text: "Equipamento para comunicações (telemóvel, rádios, etc..)" }, { id: "S2", text: "Kit primeiros socorros" }, { id: "S3", text: "Equipamento para salvamento e resgate" }, { id: "S4", text: "Kit sobrevivência (apito, frontais, faca, alimentação, etc..)" }, { id: "S5", text: "Equipamento de proteção individual e coletiva (EPI e EPC adequados)" }, ]
            };
            
            // --- DOM ELEMENTS ---
            const container = document.getElementById('risk-factors-container');
            const calculateBtnAssessment = document.getElementById('calculate-btn-assessment');
            const saveBtn = document.getElementById('save-assessment-btn');
            const clearBtn = document.getElementById('clear-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const saveStatusEl = document.getElementById('save-status');
            const evalDateInput = document.getElementById('evalDate');
            const resultsContentAssessment = document.getElementById('results-content-assessment');
            const overallClassificationEl = document.getElementById('overall-classification');
            const overallRecommendationEl = document.getElementById('overall-recommendation');
            const overallTreatmentEl = document.getElementById('overall-treatment');
            const overallResultEl = document.getElementById('overall-result');
            const extremeRiskSummaryContainer = document.getElementById('extreme-risk-summary-container');
            const extremeRiskList = document.getElementById('extreme-risk-list');
            const navAssessment = document.getElementById('nav-assessment');
            const navDashboard = document.getElementById('nav-dashboard');
            const pageAssessment = document.getElementById('page-assessment');
            const pageDashboard = document.getElementById('page-dashboard');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const exportFilteredExcelBtn = document.getElementById('export-filtered-excel-btn');
            const historyListEl = document.getElementById('assessment-history-list');

            // --- FUNCTIONS ---
            function getRiskClassification(score) { if (score >= 15) return { level: "Risco Extremo", colorClass: "risk-extreme", recommendation: "Cancelar", treatment: "Deve cancelar a atividade se não conseguir corrigir o risco." }; if (score >= 8) return { level: "Risco Elevado", colorClass: "risk-high", recommendation: "Alerta", treatment: "Deve estar em alerta e tentar corrigir os riscos identificados." }; if (score >= 4) return { level: "Risco Moderado", colorClass: "risk-moderate", recommendation: "Ponderada", treatment: "Não compromete a atividade, mas deve assumir uma gestão ponderada." }; return { level: "Risco Baixo", colorClass: "risk-low", recommendation: "Recomendada", treatment: "Não compromete a atividade." }; }
            
            function getRiskStyleClasses(riskColorClass) {
                const styleMap = {
                    'risk-low': { bg: 'bg-green-500', text: 'text-white' },
                    'risk-moderate': { bg: 'bg-yellow-400', text: 'text-black' }, // Texto escuro para melhor contraste
                    'risk-high': { bg: 'bg-orange-500', text: 'text-white' },
                    'risk-extreme': { bg: 'bg-red-500', text: 'text-white' }
                };
                return styleMap[riskColorClass] || { bg: 'bg-gray-400', text: 'text-white' };
            }
            
            function createRiskMatrix(factorId) { 
                let matrixHtml = `<div class="risk-matrix-container"><div class="axis-label">Probabilidade</div><div class="risk-matrix" id="matrix-${factorId}" data-factor-id="${factorId}">`; 
                for (let prob = 5; prob >= 1; prob--) { 
                    for (let cons = 1; cons <= 5; cons++) { 
                        const score = prob * cons; 
                        const classification = getRiskClassification(score); 
                        const isDefault = prob === 1 && cons === 1; 
                        matrixHtml += `<div class="matrix-cell ${classification.colorClass} ${isDefault ? 'selected' : ''}" data-prob="${prob}" data-cons="${cons}" data-score="${score}" title="Prob: ${prob}, Cons: ${cons}, Score: ${score}">${score}</div>`; 
                    } 
                } 
                matrixHtml += `</div><div></div><div class="consequence-labels"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div><div></div><div class="text-center text-xs font-semibold text-gray-600 col-span-5">Consequência</div></div>`; 
                return matrixHtml;
            }
            
            function updateFactorDisplay(factorId, score) { 
                const scoreEl = document.getElementById(`score-${factorId}`); 
                const classificationEl = document.getElementById(`class-${factorId}`); 
                const recommendationEl = document.getElementById(`rec-${factorId}`); 
                const treatmentEl = document.getElementById(`treat-${factorId}`); 
                const rowEl = document.getElementById(`row-${factorId}`); 
                const classification = getRiskClassification(score); 
                scoreEl.textContent = score; 
                classificationEl.textContent = classification.level; 
                recommendationEl.textContent = classification.recommendation; 
                treatmentEl.textContent = classification.treatment; 
                const badge = scoreEl.parentElement; 
                const styles = getRiskStyleClasses(classification.colorClass);
                badge.className = `risk-score-badge ${styles.bg} ${styles.text}`;
                if (classification.level === "Risco Extremo") { 
                    rowEl.classList.add('extreme-risk-alert-row'); 
                } else { 
                    rowEl.classList.remove('extreme-risk-alert-row'); 
                } 
            }

            function renderRiskFactors() {
                for (const dimension in riskData) {
                    const dimensionCard = document.createElement('div');
                    dimensionCard.className = 'card mb-8';
                    const dimensionTitle = document.createElement('h2');
                    dimensionTitle.className = 'text-2xl font-bold text-slate-100 bg-slate-600 p-4 border-b border-slate-700';
                    dimensionTitle.textContent = `Dimensão: ${dimension}`;
                    dimensionCard.appendChild(dimensionTitle);
                    
                    const contentWrapper = document.createElement('div');
                    contentWrapper.className = 'p-6';
                    const table = document.createElement('div');
                    table.className = 'space-y-6';

                    riskData[dimension].forEach((factor, index) => {
                        const row = document.createElement('div');
                        row.id = `row-${factor.id}`;
                        row.setAttribute('data-score', '1');
                        row.setAttribute('data-dimension', dimension);
                        row.className = 'grid grid-cols-1 md:grid-cols-3 gap-6 items-center p-4 rounded-lg border border-gray-200 transition-all duration-300';
                        const defaultClassification = getRiskClassification(1);
                        const defaultStyles = getRiskStyleClasses(defaultClassification.colorClass);
                        const frNumber = `FR${index + 1}`;
                        row.innerHTML = `<div class="md:col-span-1"><p class="font-semibold text-gray-800 flex items-start gap-2"><svg class="w-5 h-5 extreme-risk-icon flex-shrink-0 mt-1"><use xlink:href="#icon-alert-triangle"></use></svg><span class="font-bold text-gray-500 w-12 flex-shrink-0">${frNumber}:</span><span id="text-${factor.id}">${factor.text}</span></p></div><div class="md:col-span-1 flex justify-center">${createRiskMatrix(factor.id)}</div><div class="md:col-span-1 flex flex-col items-center justify-center text-center"><div class="risk-score-badge ${defaultStyles.bg} ${defaultStyles.text}"><span id="score-${factor.id}">1</span></div><span id="class-${factor.id}" class="text-lg font-bold text-gray-800 mt-2">${defaultClassification.level}</span><div class="text-xs text-left mt-2 p-2 bg-gray-50 rounded-md border w-full"><p><strong class="text-gray-600">Recomendação:</strong> <span id="rec-${factor.id}">${defaultClassification.recommendation}</span></p><p class="mt-1"><strong class="text-gray-600">Tratamento:</strong> <span id="treat-${factor.id}">${defaultClassification.treatment}</span></p></div></div>`;
                        table.appendChild(row);
                    });
                    contentWrapper.appendChild(table);
                    dimensionCard.appendChild(contentWrapper);
                    container.appendChild(dimensionCard);
                }
                document.querySelectorAll('.risk-matrix').forEach(matrix => {
                    matrix.addEventListener('click', (e) => {
                        if (e.target.classList.contains('matrix-cell')) {
                            const cell = e.target;
                            const factorId = matrix.dataset.factorId;
                            const score = cell.dataset.score;
                            document.getElementById(`row-${factorId}`).setAttribute('data-score', score);
                            updateFactorDisplay(factorId, score);
                            const currentSelected = matrix.querySelector('.selected');
                            if (currentSelected) currentSelected.classList.remove('selected');
                            cell.classList.add('selected');
                        }
                    });
                });
            }
            
            function calculateAndShowResults() {
                let highestRiskScore = 0;
                const extremeRiskFactors = [];
                const dimensionRiskCounts = {};
                Object.keys(riskData).forEach(dim => { dimensionRiskCounts[dim] = { "Risco Baixo": 0, "Risco Moderado": 0, "Risco Elevado": 0, "Risco Extremo": 0 }; });
                document.querySelectorAll('[id^="row-"]').forEach(row => { const score = parseInt(row.dataset.score, 10); if (score > highestRiskScore) highestRiskScore = score; const classification = getRiskClassification(score); const dimension = row.dataset.dimension; if (dimensionRiskCounts[dimension]) { dimensionRiskCounts[dimension][classification.level]++; } if (classification.level === "Risco Extremo") { const factorId = row.id.split('-')[1]; const factorText = document.getElementById(`text-${factorId}`).textContent; const frNumberEl = row.querySelector('.font-bold.text-gray-500'); const frNumber = frNumberEl ? frNumberEl.textContent : ''; extremeRiskFactors.push(`${frNumber} ${factorText}`); } });
                if (extremeRiskFactors.length > 0) { extremeRiskList.innerHTML = `<p class="font-bold text-lg mb-2 text-center">Recomendação Final: Cancelar Atividade</p><p class="text-sm mb-2">Os seguintes fatores de risco foram identificados como extremos:</p><ul>${extremeRiskFactors.map(text => `<li class="mt-1 ml-4 list-disc">${text}</li>`).join('')}</ul>`; extremeRiskSummaryContainer.classList.remove('hidden'); } else { extremeRiskSummaryContainer.classList.add('hidden'); }
                const overallClassification = getRiskClassification(highestRiskScore);
                overallClassificationEl.textContent = overallClassification.level;
                overallRecommendationEl.textContent = overallClassification.recommendation;
                overallTreatmentEl.textContent = overallClassification.treatment;
                const styles = getRiskStyleClasses(overallClassification.colorClass);
                overallResultEl.className = `p-6 rounded-lg text-center flex flex-col justify-center h-full ${styles.bg} ${styles.text}`;
                overallClassificationEl.className = `text-4xl font-bold`;
                resultsContentAssessment.classList.remove('hidden');
                updateAssessmentSummaryChart(dimensionRiskCounts);
            }

            function updateAssessmentSummaryChart(dimensionRiskCounts) {
                const ctx = document.getElementById('assessment-summary-chart').getContext('2d');
                const labels = Object.keys(dimensionRiskCounts);
                const riskLevels = ["Risco Baixo", "Risco Moderado", "Risco Elevado", "Risco Extremo"];
                const colors = ['#22c55e', '#facc15', '#f97316', '#ef4444'];
                const datasets = riskLevels.map((level, index) => ({ label: level, data: labels.map(dim => dimensionRiskCounts[dim][level]), backgroundColor: colors[index], }));
                if (assessmentSummaryChart) assessmentSummaryChart.destroy();
                assessmentSummaryChart = new Chart(ctx, { type: 'bar', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: false }, y: { stacked: false, beginAtZero: true, title: { display: true, text: 'Nº de Fatores de Risco' }, ticks: { stepSize: 1 } } }, plugins: { legend: { display: true, position: 'bottom' } } } });
            }

            async function saveAssessment() {
                if (!authReady) { 
                    saveStatusEl.textContent = "A aguardar ligação à base de dados. Tente novamente em alguns segundos."; 
                    saveStatusEl.className = "mt-4 text-orange-600 font-semibold"; 
                    return; 
                }
                const generalInfo = { evaluatorName: document.getElementById('evaluatorName').value.trim(), evalDate: document.getElementById('evalDate').value, location: document.getElementById('location').value.trim(), activity: document.getElementById('activity').value.trim(), };
                if (!generalInfo.evaluatorName || !generalInfo.evalDate || !generalInfo.location || !generalInfo.activity) { saveStatusEl.textContent = "Por favor, preencha todas as informações da avaliação."; saveStatusEl.className = "mt-4 text-red-600 font-semibold"; return; }
                let highestRiskScore = 0;
                const evaluatedFactors = [];
                document.querySelectorAll('[id^="row-"]').forEach(row => { const score = parseInt(row.dataset.score, 10); if (score > highestRiskScore) highestRiskScore = score; const factorId = row.id.split('-')[1]; evaluatedFactors.push({ id: factorId, text: document.getElementById(`text-${factorId}`).textContent, score: score, dimension: row.dataset.dimension, }); });
                const overallClassification = getRiskClassification(highestRiskScore);
                const assessmentData = { ...generalInfo, createdAt: new Date().toISOString(), overallRiskLevel: overallClassification.level, overallRecommendation: overallClassification.recommendation, factors: evaluatedFactors, };
                try {
                    // Use a public path that doesn't depend on userId
                    await db.collection(`cmar_assessments`).add(assessmentData);
                    saveStatusEl.textContent = "Avaliação guardada com sucesso!";
                    saveStatusEl.className = "mt-4 text-green-600 font-semibold";
                    setTimeout(() => { saveStatusEl.textContent = ""; }, 3000);
                } catch (error) { console.error("Error adding document: ", error); saveStatusEl.textContent = "Erro ao guardar a avaliação. Tente novamente."; saveStatusEl.className = "mt-4 text-red-600 font-semibold"; }
            }

            function clearForm() {
                document.getElementById('evaluatorName').value = ''; evalDateInput.valueAsDate = new Date(); document.getElementById('location').value = ''; document.getElementById('activity').value = '';
                document.querySelectorAll('.risk-matrix').forEach(matrix => { const factorId = matrix.dataset.factorId; const defaultCell = matrix.querySelector('[data-score="1"]'); const currentSelected = matrix.querySelector('.selected'); if (currentSelected) currentSelected.classList.remove('selected'); if (defaultCell) defaultCell.classList.add('selected'); document.getElementById(`row-${factorId}`).setAttribute('data-score', '1'); updateFactorDisplay(factorId, 1); });
                resultsContentAssessment.classList.add('hidden');
            }

            function loadAssessments() {
                if (!db) return;
                // Use a public path that doesn't depend on userId
                db.collection(`cmar_assessments`).orderBy("createdAt", "desc").onSnapshot((querySnapshot) => {
                    allAssessments = [];
                    querySnapshot.forEach((doc) => { allAssessments.push({ id: doc.id, ...doc.data() }); });
                    applyFilters();
                }, (error) => {
                    console.error("Error loading assessments: ", error);
                    historyListEl.innerHTML = '<p class="text-red-500">Erro ao carregar as avaliações. Verifique a consola para mais detalhes.</p>';
                });
            }

            function applyFilters() {
                const startDate = document.getElementById('filter-start-date').value;
                const endDate = document.getElementById('filter-end-date').value;
                const location = document.getElementById('filter-location').value.toLowerCase();
                const evaluator = document.getElementById('filter-evaluator').value.toLowerCase();
                filteredAssessments = allAssessments.filter(item => { const itemDate = item.evalDate; const isAfterStart = !startDate || itemDate >= startDate; const isBeforeEnd = !endDate || itemDate <= endDate; const hasLocation = !location || item.location.toLowerCase().includes(location); const hasEvaluator = !evaluator || item.evaluatorName.toLowerCase().includes(evaluator); return isAfterStart && isBeforeEnd && hasLocation && hasEvaluator; });
                renderHistoryList(filteredAssessments);
                updateAnalysisChart(filteredAssessments);
            }

            function renderHistoryList(assessments) {
                if (assessments.length === 0) { historyListEl.innerHTML = '<p>Nenhuma avaliação encontrada para os filtros selecionados.</p>'; return; }
                historyListEl.innerHTML = assessments.map(item => {
                    const classification = getRiskClassification(Math.max(...item.factors.map(f => f.score)));
                    const styles = getRiskStyleClasses(classification.colorClass);
                    return `
                        <div class="border rounded-lg p-4 flex justify-between items-center">
                            <div>
                                <p class="font-bold">${item.activity} em ${item.location}</p>
                                <p class="text-sm text-gray-600">Avaliador: ${item.evaluatorName} em ${new Date(item.evalDate).toLocaleDateString()}</p>
                            </div>
                            <div class="text-right">
                               <span class="px-3 py-1 text-sm font-semibold ${styles.bg} ${styles.text} rounded-full">${classification.level}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function updateAnalysisChart(filteredData) {
                const ctx = document.getElementById('analysis-chart').getContext('2d');
                const riskCounts = { "Risco Baixo": 0, "Risco Moderado": 0, "Risco Elevado": 0, "Risco Extremo": 0 };
                filteredData.forEach(assessment => { assessment.factors.forEach(factor => { const classification = getRiskClassification(factor.score); riskCounts[classification.level]++; }); });
                if (analysisChart) analysisChart.destroy();
                analysisChart = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(riskCounts), datasets: [{ label: 'Nº Total de Fatores por Nível de Risco', data: Object.values(riskCounts), backgroundColor: ['#22c55e', '#facc15', '#f97316', '#ef4444'], }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } });
            }
            
            function exportSingleAssessmentToExcel() {
                if (resultsContentAssessment.classList.contains('hidden')) { alert("Por favor, clique em 'Calcular Resultados' antes de exportar para Excel."); return; }
                const generalInfo = { Avaliador: document.getElementById('evaluatorName').value, Data: document.getElementById('evalDate').value, Local: document.getElementById('location').value, Atividade: document.getElementById('activity').value, };
                const dataToExport = [];
                for (const key in generalInfo) { dataToExport.push({ Categoria: key, Detalhe: generalInfo[key] }); }
                dataToExport.push({});
                dataToExport.push({ Categoria: 'Dimensão', Detalhe: 'Fator de Risco', 'Score': 'Score', 'Nível de Risco': 'Nível de Risco' });
                document.querySelectorAll('[id^="row-"]').forEach((row, index) => {
                    const factorId = row.id.split('-')[1];
                    const frNumber = `FR${index % (riskData[row.dataset.dimension].length) + 1}`;
                    const text = document.getElementById(`text-${factorId}`).textContent;
                    const score = row.dataset.score;
                    const level = getRiskClassification(parseInt(score)).level;
                    dataToExport.push({ Categoria: row.dataset.dimension, Detalhe: `${frNumber}: ${text}`, 'Score': score, 'Nível de Risco': level });
                });
                const worksheet = XLSX.utils.json_to_sheet(dataToExport, { skipHeader: true });
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Avaliação CMAR");
                XLSX.writeFile(workbook, `CMAR_Avaliacao_${generalInfo.Data || 'single'}.xlsx`);
            }

            function exportFilteredAssessmentsToExcel() {
                if (filteredAssessments.length === 0) { alert("Não há dados filtrados para exportar."); return; }
                const summaryData = filteredAssessments.map(item => ({ 'Data': item.evalDate, 'Avaliador': item.evaluatorName, 'Local': item.location, 'Atividade': item.activity, 'Nível de Risco Geral': item.overallRiskLevel, 'Recomendação': item.overallRecommendation }));
                const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                const detailedData = [];
                filteredAssessments.forEach((item, index) => { item.factors.forEach(factor => { detailedData.push({ 'ID Avaliação': index + 1, 'Data': item.evalDate, 'Avaliador': item.evaluatorName, 'Local': item.location, 'Atividade': item.activity, 'Dimensão': factor.dimension, 'Fator de Risco': factor.text, 'Score': factor.score, 'Nível de Risco': getRiskClassification(factor.score).level }); }); });
                const detailedSheet = XLSX.utils.json_to_sheet(detailedData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, summarySheet, "Resumo");
                XLSX.utils.book_append_sheet(workbook, detailedSheet, "Dados Completos");
                XLSX.writeFile(workbook, `CMAR_Export_Filtrado_${new Date().toISOString().slice(0,10)}.xlsx`);
            }

            function switchPage(pageToShow) {
                [pageAssessment, pageDashboard].forEach(p => p.classList.remove('active'));
                [navAssessment, navDashboard].forEach(n => n.classList.remove('active'));
                if (pageToShow === 'dashboard') { pageDashboard.classList.add('active'); navDashboard.classList.add('active'); } else { pageAssessment.classList.add('active'); navAssessment.classList.add('active'); }
            }
            
            // --- INITIALIZATION ---
            renderRiskFactors();
            evalDateInput.valueAsDate = new Date();
            calculateBtnAssessment.addEventListener('click', calculateAndShowResults);
            saveBtn.addEventListener('click', saveAssessment);
            clearBtn.addEventListener('click', clearForm);
            exportPdfBtn.addEventListener('click', () => {
                if (resultsContentAssessment.classList.contains('hidden')) { alert("Por favor, clique em 'Calcular Resultados' antes de exportar para PDF."); return; }
                const { jsPDF } = window.jspdf;
                html2canvas(document.getElementById('page-assessment'), { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    const width = pdfWidth;
                    const height = width / ratio;
                    let position = 0;
                    let pageHeight = height;
                    
                    if (pageHeight > pdfHeight) {
                        pageHeight = pdfHeight;
                    }
                    
                    pdf.addImage(imgData, 'PNG', 0, position, width, height);
                    let heightLeft = height - pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - height;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, width, height);
                        heightLeft -= pageHeight;
                    }
                    pdf.save(`CMAR_Avaliacao_${new Date().toISOString().slice(0,10)}.pdf`);
                });
            });
            exportExcelBtn.addEventListener('click', exportSingleAssessmentToExcel);
            exportFilteredExcelBtn.addEventListener('click', exportFilteredAssessmentsToExcel);
            navAssessment.addEventListener('click', () => switchPage('assessment'));
            navDashboard.addEventListener('click', () => switchPage('dashboard'));
            applyFiltersBtn.addEventListener('click', applyFilters);
        });
    </script>
</body>
</html>
